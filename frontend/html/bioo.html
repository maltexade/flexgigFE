<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebAuthn Biometric — Instant Fingerprint</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, Arial; max-width: 720px; margin: 32px auto; padding: 0 16px; color: #111; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; margin-right: 8px; }
    pre { background:#f7f7f8; padding:12px; border-radius:6px; overflow:auto; }
    .ok { color: green; }
    .err { color: #b00020; }
    .row { margin-bottom: 12px; }
  </style>
</head>
<body>
  <h2>WebAuthn — Instant Biometric Prompt</h2>
  <div class="row">
    <button id="checkBtn">Check Biometric Availability</button>
    <button id="registerBtn">Register Biometric</button>
    <button id="authBtn">Authenticate Biometric</button>
    <button id="removeBtn">Clear Local Data</button>
  </div>

  <div class="row"><strong>Status:</strong> <span id="status">idle</span></div>
  <div class="row"><strong>Output:</strong></div>
  <pre id="out">No credential yet.</pre>

<script>
const API_BASE = 'https://api.flexgig.com.ng';

/* ---------- Helpers ---------- */
function toBase64Url(buffer) {
  if (!buffer) return null; // handle undefined/null safely
  if (buffer instanceof ArrayBuffer === false && !(buffer.buffer instanceof ArrayBuffer))
    throw new TypeError('Expected ArrayBuffer or TypedArray');
  const bytes = new Uint8Array(buffer instanceof ArrayBuffer ? buffer : buffer.buffer);
  let str = '';
  for (let i = 0; i < bytes.byteLength; i++) str += String.fromCharCode(bytes[i]);
  return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

function fromBase64Url(b64url) {
  b64url = b64url.replace(/-/g, '+').replace(/_/g, '/');
  while (b64url.length % 4) b64url += '=';
  const str = atob(b64url);
  const arr = new Uint8Array(str.length);
  for (let i = 0; i < str.length; i++) arr[i] = str.charCodeAt(i);
  return arr.buffer;
}
function logStatus(msg, isErr = false) {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.className = isErr ? 'err' : 'ok';
}
function showOutput(obj) {
  document.getElementById('out').textContent = JSON.stringify(obj, null, 2);
}

/* ---------- Check device ---------- */
document.getElementById('checkBtn').addEventListener('click', async () => {
  logStatus('Checking biometric availability...');
  try {
    if (!window.PublicKeyCredential) throw new Error('WebAuthn not supported');
    const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
    logStatus('Platform authenticator available: ' + available);
  } catch (e) {
    logStatus('Error checking: ' + e.message, true);
  }
});

/* ---------- Registration ---------- */
document.getElementById('registerBtn').addEventListener('click', async () => {
  logStatus('Requesting registration options from server...');
  try {
    const userId = 'demo-user-' + Math.floor(Math.random() * 10000);

    // 1️⃣ Request options from backend
    const optRes = await fetch(`${API_BASE}/webauthn/register/options`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, username: 'demo@example.com', displayName: 'Demo User' })
    });
    const publicKey = await optRes.json();

    // Convert challenge/user.id to ArrayBuffers
    publicKey.challenge = fromBase64Url(publicKey.challenge);
    publicKey.user.id = fromBase64Url(publicKey.user.id);

    // 2️⃣ Trigger biometric (force platform only)
    logStatus('Prompting device biometric...');
    const cred = await navigator.credentials.create({
      publicKey: {
        ...publicKey,
        authenticatorSelection: {
          authenticatorAttachment: 'platform', // only device biometric
          residentKey: 'preferred',
          userVerification: 'required',
        },
        excludeCredentials: [],
        attestation: 'none',
      },
    });
    if (!cred) throw new Error('No credential returned');

    // 3️⃣ Send result to backend for verification
    // 3️⃣ Send result to backend for verification
const encodedRawId = toBase64Url(cred.rawId);
const payload = {
  id: encodedRawId,                 // ✅ use encoded version for both
  rawId: encodedRawId,
  type: cred.type,
  response: {
    attestationObject: toBase64Url(cred.response?.attestationObject),
    clientDataJSON: toBase64Url(cred.response?.clientDataJSON),
  },
};



    const verifyRes = await fetch(`${API_BASE}/webauthn/register/verify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const verifyData = await verifyRes.json();
    if (!verifyRes.ok) throw new Error(verifyData.error || 'Server verification failed');

    localStorage.setItem('webauthn-cred-id', payload.rawId);
    logStatus('Registration successful ✅');
    showOutput(verifyData);
  } catch (err) {
    console.error(err);
    logStatus('Registration error: ' + err.message, true);
  }
});

/* ---------- Authentication ---------- */
document.getElementById('authBtn').addEventListener('click', async () => {
  logStatus('Requesting authentication options...');
  try {
    const storedRawId = localStorage.getItem('webauthn-cred-id');
    if (!storedRawId) throw new Error('No stored credential. Register first.');

    // 1️⃣ Get challenge/options from server
    const optRes = await fetch(`${API_BASE}/webauthn/auth/options`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: 'demo-user' }),
    });
    const publicKey = await optRes.json();

    publicKey.challenge = fromBase64Url(publicKey.challenge);
    if (publicKey.allowCredentials) {
      publicKey.allowCredentials = publicKey.allowCredentials.map(c => ({
        ...c,
        id: fromBase64Url(c.id),
      }));
    }

    // 2️⃣ Trigger direct biometric prompt (no passkey chooser)
    logStatus('Prompting biometric for authentication...');
    await navigator.credentials.preventSilentAccess();
    const assertion = await navigator.credentials.get({
      mediation: 'required',
      publicKey: {
        ...publicKey,
        timeout: 60000,
        userVerification: 'required',
        allowCredentials: [
          {
            type: 'public-key',
            id: fromBase64Url(storedRawId),
            transports: ['internal'], // force fingerprint/face only
          },
        ],
      },
    });
    if (!assertion) throw new Error('No assertion returned');

    // 3️⃣ Send result to backend for verification
    const encodedRawId = toBase64Url(assertion.rawId);
const payload = {
  id: encodedRawId,                 // ✅ same encoding fix
  rawId: encodedRawId,
  type: assertion.type,
  response: {
    authenticatorData: toBase64Url(assertion.response.authenticatorData),
    clientDataJSON: toBase64Url(assertion.response.clientDataJSON),
    signature: toBase64Url(assertion.response.signature),
    userHandle: assertion.response.userHandle
      ? toBase64Url(assertion.response.userHandle)
      : null,
  },
};


    const verifyRes = await fetch(`${API_BASE}/webauthn/auth/verify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const verifyData = await verifyRes.json();
    if (!verifyRes.ok) throw new Error(verifyData.error || 'Server verification failed');

    logStatus(verifyData.verified ? 'Authentication successful ✅' : 'Authentication failed ❌');
    showOutput(verifyData);
  } catch (err) {
    console.error(err);
    logStatus('Authentication error: ' + err.message, true);
  }
});

/* ---------- Clear ---------- */
document.getElementById('removeBtn').addEventListener('click', () => {
  localStorage.removeItem('webauthn-cred-id');
  showOutput({ msg: 'Removed stored credential ID.' });
  logStatus('Cleared local data');
});
</script>
</body>
</html>
