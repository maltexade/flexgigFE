<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FlexGig — Biometric Auth Hex Debug</title>
<style>
  body { font-family: system-ui, -apple-system, Roboto, Arial; max-width: 720px; margin: 32px auto; padding: 0 16px; color: #111; }
  button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; margin-right: 8px; }
  pre { background:#f7f7f8; padding:12px; border-radius:6px; overflow:auto; }
  .ok { color: green; }
  .err { color: #b00020; }
  .row { margin-bottom: 12px; }
</style>
</head>
<body>
<h2>FlexGig — Biometric Debug Hex Login</h2>
<div class="row">
  <button id="checkBtn">Check Biometric Availability</button>
  <button id="registerBtn">Register Biometric</button>
  <button id="authBtn">Authenticate</button>
  <button id="removeBtn">Clear Local Data</button>
</div>
<div class="row"><strong>Status:</strong> <span id="status">idle</span></div>
<div class="row"><strong>Output:</strong></div>
<pre id="out">No credential yet.</pre>

<script>
const API_BASE = 'https://api.flexgig.com.ng';

/* ---------- Helpers ---------- */
function toBase64Url(buffer) {
  const bytes = new Uint8Array(buffer);
  let str = '';
  for (let i = 0; i < bytes.length; i++) str += String.fromCharCode(bytes[i]);
  return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

function fromBase64Url(b64url) {
  b64url = b64url.replace(/-/g, '+').replace(/_/g, '/');
  while (b64url.length % 4) b64url += '=';
  const str = atob(b64url);
  const arr = new Uint8Array(str.length);
  for (let i = 0; i < str.length; i++) arr[i] = str.charCodeAt(i);
  return arr.buffer;
}

function bufferToHex(buffer) {
  const bytes = new Uint8Array(buffer);
  return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
}

function logStatus(msg, err=false) {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.className = err ? 'err' : 'ok';
  console.log('[STATUS]', msg);
}

function showOutput(obj) {
  document.getElementById('out').textContent = JSON.stringify(obj, null, 2);
  console.log('[OUTPUT]', obj);
}

/* ---------- Check Biometric Availability ---------- */
document.getElementById('checkBtn').addEventListener('click', async () => {
  try {
    const supported = !!window.PublicKeyCredential;
    const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
    logStatus(supported && available ? 'Biometric available ✅' : 'Not supported ❌');
  } catch (e) {
    logStatus('Error: ' + e.message, true);
  }
});

/* ---------- Register ---------- */
document.getElementById('registerBtn').addEventListener('click', async () => {
  logStatus('Requesting registration options...');
  try {
    const userId = 'demo-user-' + Math.floor(Math.random() * 10000);

    console.log('[DEBUG] Sending /register/options request with userId:', userId);
    const optRes = await fetch(`${API_BASE}/webauthn/register/options`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, username: 'demo@example.com', displayName: 'Demo User' })
    });

    const publicKey = await optRes.json();
    console.log('[DEBUG] Received registration options:', publicKey);

    publicKey.challenge = fromBase64Url(publicKey.challenge);
    publicKey.user.id = fromBase64Url(publicKey.user.id);

    const cred = await navigator.credentials.create({ publicKey });
    if (!cred) throw new Error('No credential returned');
    console.log('[DEBUG] Credential created:', cred);
    console.log('[DEBUG] Credential rawId (hex):', bufferToHex(cred.rawId));
    console.log('[DEBUG] AttestationObject (hex):', bufferToHex(cred.response.attestationObject));
    console.log('[DEBUG] clientDataJSON (hex):', bufferToHex(cred.response.clientDataJSON));

    const payload = {
      id: toBase64Url(cred.rawId),
      rawId: toBase64Url(cred.rawId),
      type: cred.type,
      response: {
        attestationObject: toBase64Url(cred.response.attestationObject),
        clientDataJSON: toBase64Url(cred.response.clientDataJSON),
      },
    };

    console.log('[DEBUG] Sending /register/verify payload:', payload);
    const verifyRes = await fetch(`${API_BASE}/webauthn/register/verify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const verifyData = await verifyRes.json();
    console.log('[DEBUG] Verification response:', verifyData);

    if (!verifyRes.ok) throw new Error(verifyData.error || 'Server verification failed');

    localStorage.setItem('webauthn-cred-id', payload.rawId);
    logStatus('Registration successful ✅');
    showOutput(verifyData);

  } catch (err) {
    console.error('[ERROR] Registration failed:', err);
    logStatus('Registration error: ' + err.message, true);
  }
});

/* ---------- Authenticate ---------- */
document.getElementById('authBtn').addEventListener('click', async () => {
  logStatus('Authenticating...');
  try {
    const storedId = localStorage.getItem('webauthn-cred-id');
    if (!storedId) throw new Error('No credential stored');

    const optRes = await fetch(`${API_BASE}/webauthn/auth/options`, { method: 'POST' });
    const publicKey = await optRes.json();

    // Convert challenge to ArrayBuffer
    publicKey.challenge = fromBase64Url(publicKey.challenge);
    publicKey.allowCredentials = [{
      type: 'public-key',
      id: fromBase64Url(storedId),
      transports: ['internal'],
    }];

    console.log('--- PUBLICKEY OPTIONS SENT TO NAVIGATOR ---');
    console.log(publicKey);

    const assertion = await navigator.credentials.get({ publicKey });
    if (!assertion) throw new Error('No assertion returned');

    console.log('--- RAW ASSERTION RETURNED BY WINDOWS HELLO ---');
    console.log(assertion);

    // Convert ArrayBuffers to Base64URL safely
    function bufferToBase64url(buf) {
      return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    const payload = {
      id: assertion.id,
      rawId: bufferToBase64url(assertion.rawId),
      type: assertion.type,
      response: {
        authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
        clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
        signature: bufferToBase64url(assertion.response.signature),
        userHandle: assertion.response.userHandle
          ? bufferToBase64url(assertion.response.userHandle)
          : null,
      },
    };

    console.log('--- FINAL PAYLOAD SENT TO SERVER ---');
    console.log(payload);

    const verifyRes = await fetch(`${API_BASE}/webauthn/auth/verify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const verifyData = await verifyRes.json();
    console.log('--- SERVER RESPONSE ---');
    console.log(verifyData);

    logStatus(verifyData.verified ? 'Authentication successful ✅' : 'Authentication failed ❌');
    showOutput(verifyData);
  } catch (err) {
    console.error(err);
    logStatus('Auth error: ' + err.message, true);
  }
});


/* ---------- Clear Local Data ---------- */
document.getElementById('removeBtn').addEventListener('click', () => {
  localStorage.removeItem('webauthn-cred-id');
  logStatus('Cleared local data');
  showOutput({ msg: 'Credential removed.' });
});
</script>
</body>
</html>
