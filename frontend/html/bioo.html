<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebAuthn Biometric Registration — Minimal Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, Arial; max-width: 720px; margin: 32px auto; padding: 0 16px; color: #111; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; margin-right: 8px; }
    pre { background:#f7f7f8; padding:12px; border-radius:6px; overflow:auto; }
    .ok { color: green; }
    .err { color: #b00020; }
    .row { margin-bottom: 12px; }
  </style>
</head>
<body>
  <h2>WebAuthn — Biometric Registration (minimal)</h2>
  <div class="row">
    <button id="checkBtn">Check platform authenticator</button>
    <button id="registerBtn">Register Biometric (create)</button>
    <button id="showBtn">Show Stored Credential</button>
    <button id="removeBtn">Remove Stored Credential</button>
  </div>

  <div class="row"><strong>Status:</strong> <span id="status">idle</span></div>
  <div class="row"><strong>Stored credential (localStorage):</strong></div>
  <pre id="out">No credential yet.</pre>

<script>
/* ----- helpers ----- */
function toBase64Url(buffer) {
  const bytes = new Uint8Array(buffer);
  let str = '';
  for (let i=0;i<bytes.byteLength;i++){
    str += String.fromCharCode(bytes[i]);
  }
  // base64
  let b64 = btoa(str);
  // base64url
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function fromBase64Url(b64url) {
  b64url = b64url.replace(/-/g,'+').replace(/_/g,'/');
  // pad
  while(b64url.length % 4) b64url += '=';
  const str = atob(b64url);
  const arr = new Uint8Array(str.length);
  for (let i=0;i<str.length;i++) arr[i] = str.charCodeAt(i);
  return arr.buffer;
}
function logStatus(msg, isErr=false) {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.className = isErr ? 'err' : 'ok';
}
function showOutput(obj) {
  document.getElementById('out').textContent = JSON.stringify(obj, null, 2);
}

/* ----- UI handlers ----- */
document.getElementById('checkBtn').addEventListener('click', async () => {
  logStatus('checking platform authenticator availability...');
  try {
    if (!window.PublicKeyCredential) {
      logStatus('WebAuthn (PublicKeyCredential) not available in this browser', true);
      return;
    }
    const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
    logStatus('Platform authenticator available: ' + available);
  } catch (e) {
    console.error(e);
    logStatus('Error checking availability: ' + e.message, true);
  }
});

document.getElementById('registerBtn').addEventListener('click', async () => {
  logStatus('starting registration...');
  try {
    if (!window.PublicKeyCredential) throw new Error('WebAuthn not supported');

    // Minimal options for client-side testing (NOT secure for production)
    const challenge = crypto.getRandomValues(new Uint8Array(32));
    const userId = crypto.getRandomValues(new Uint8Array(16)); // sample user id

    const publicKey = {
      challenge: challenge.buffer,
      rp: { name: "Demo (local)" },
      user: {
        id: userId.buffer,
        name: "demo@example.com",
        displayName: "Demo User"
      },
      pubKeyCredParams: [
        { type: "public-key", alg: -7 },   // "ES256"
        { type: "public-key", alg: -257 }  // "RS256"
      ],
      timeout: 60000,
      attestation: "direct", // for demo; won't be validated here
      authenticatorSelection: {
        // prefer a platform authenticator (face/fingerprint on device)
        authenticatorAttachment: "platform",
        requireResidentKey: false,
        userVerification: "preferred"
      }
    };

    // navigator.credentials.create will prompt the biometric / authenticator UI
    const cred = await navigator.credentials.create({ publicKey });

    if (!cred) throw new Error('No credential returned');

    // Extract useful fields and store as base64url
    const rawIdB64 = toBase64Url(cred.rawId);
    const attObj = cred.response && cred.response.attestationObject ? toBase64Url(cred.response.attestationObject) : null;
    const clientData = cred.response && cred.response.clientDataJSON ? toBase64Url(cred.response.clientDataJSON) : null;

    const stored = {
      id: cred.id,
      rawId: rawIdB64,
      type: cred.type,
      attestationObject: attObj,
      clientDataJSON: clientData,
      createdAt: new Date().toISOString()
    };

    // Save locally (for demo). Real app: send to server for verification & storage.
    localStorage.setItem('webauthn-demo-cred', JSON.stringify(stored));
    logStatus('Registration successful — credential stored locally');
    showOutput(stored);
  } catch (err) {
    console.error('register error', err);
    logStatus('Registration error: ' + (err && err.message ? err.message : String(err)), true);
  }
});

document.getElementById('showBtn').addEventListener('click', () => {
  const val = localStorage.getItem('webauthn-demo-cred');
  if (!val) {
    showOutput({ msg: 'No credential saved in localStorage.' });
    logStatus('no stored credential');
  } else {
    showOutput(JSON.parse(val));
    logStatus('displaying stored credential');
  }
});

document.getElementById('removeBtn').addEventListener('click', () => {
  localStorage.removeItem('webauthn-demo-cred');
  showOutput({ msg: 'Removed stored credential.' });
  logStatus('removed stored credential');
});

/* show existing on load */
const onLoadStored = localStorage.getItem('webauthn-demo-cred');
if (onLoadStored) {
  try { showOutput(JSON.parse(onLoadStored)); } catch (e) { showOutput({err:e.message}); }
}
</script>
</body>
</html>
